name: Deployment pipeline

on:
  push:
    branches:
      - master
      # note that your "main" branch might be called main instead of master
  pull_request:
    branches: [master]
    types: [opened, synchronize]
    
jobs:
  hello_world_job:
    name: Hello World
    runs-on: ubuntu-20.04
    steps:
      - name: Say hello
        run: |
          echo "Hello World!"
      - name: show date
        run: |
          current_date=$(TZ="Europe/Helsinki" date +'%a %b %e %T %Z %Y')
          echo "Current Date (in Finland's time zone): $current_date"
      - name: Run ls -l
        run: |
          current_content=$(ls -l)
          echo $current_content
  
  simple_deployment_pipeline:
    runs-on: ubuntu-20.04
    defaults:
      run:
        working-directory: ./fullstackopen-cicd/
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: check ls
        run: ls
      - name: instal package
        run: npm install
      - name: eslint
        run: npm run eslint
      - name: build
        run: npm run build
      - name: test
        run: npm run test
      - name: e2e tests
        uses: cypress-io/github-action@v6
        with: 
          working-directory: fullstackopen-cicd
          command: npm run test:e2e
          start: npm run start-prod
          wait-on: http://localhost:5000

  tag_release:
    needs: [simple_deployment_pipeline]
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'push' }}
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: '0'

    - name: Bump version and push tag
      uses: anothrNick/github-tag-action@1.64.0 # Don't use @master or @v1 unless you're happy to test the latest version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # if you don't want to set write permissions use a PAT token
        WITH_V: false


  Deployment: 
    name: Deploy
    needs: [simple_deployment_pipeline] # Our tests must pass in order to run the deploy job
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: github context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: commits
        env:
          COMMITS: ${{ toJson(github.event.commits) }}
        run: echo "$COMMITS"
      - name: commit messages
        env:
          COMMIT_MESSAGES: ${{ toJson(github.event.commits.*.message) }}
        run: echo "$COMMIT_MESSAGES"      
      - name: Deploy
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}





# name: Deployment pipeline

# on:
#   push:
#     branches:
#       - master
#       # note that your "main" branch might be called main instead of master
# jobs:
#   simple_deployment_pipeline:
#     runs-on: ubuntu-20.04
#     defaults:
#       run:
#         working-directory: ./fullstackopen-cicd/
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v3
#       - uses: oven-sh/setup-bun@v1
#         with:
#           bun-version: latest
#       - name: Verify Bun
#         run: |
#           bun --version
#       - name: check ls
#         run: ls
#       - name: instal package
#         run: bun install
#       - name: eslint
#         run: bun run eslint
#       - name: build
#         run: bun run build
#       - name: test
#         run: bun run test
#       - name: e2e tests
#         uses: cypress-io/github-action@v6
#         with: 
#           working-directory: fullstackopen-cicd
#           command: bun run test:e2e
#           start: bun run start-prod
#           wait-on: https://localhost:5000





